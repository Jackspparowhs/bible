<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Flight Tracker Map — PirateRuler.com</title>
<link rel="icon" href="https://pirateruler.com/static/pr-logo.png" type="image/png">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
<style>
  html,body,#map{height:100%;margin:0;padding:0}
  body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial; background:#071225; color:#e9f1ff}
  .topbar{display:flex;align-items:center;justify-content:space-between;padding:8px 12px;background:linear-gradient(90deg, rgba(6,16,40,0.9), rgba(7,18,37,0.9));color:#fff;box-shadow:0 6px 18px rgba(0,0,0,0.45);position:relative;z-index:1000;gap:12px;}
  .brand{display:flex;align-items:center;gap:10px}
  .logo{width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg,#6bbf4a,#2fa64f);display:flex;align-items:center;justify-content:center;font-weight:900;font-size:14px;color:#06221a;box-shadow:0 6px 18px rgba(0,0,0,0.35);}
  .controls{display:flex;gap:8px;align-items:center}
  .search{display:flex;align-items:center;gap:8px;background:rgba(255,255,255,0.03);padding:6px 8px;border-radius:8px;}
  input[type="search"]{background:transparent;border:0;color:#fff;outline:0;padding:6px 8px;font-size:14px;width:220px}
  .btn{cursor:pointer;border:0;padding:8px 10px;border-radius:8px;background:linear-gradient(90deg,#6bbf4a,#2fa64f);color:#fff;font-weight:800;font-size:13px}
  #map{position:absolute;top:56px;bottom:0;left:0;right:0}
  .status{position:absolute;right:12px;bottom:12px;z-index:1000;background:rgba(0,0,0,0.45);color:#fff;padding:6px 10px;border-radius:8px;font-size:13px;pointer-events:none;opacity:0.95}
  .legend{position:absolute;left:12px;bottom:12px;background:rgba(0,0,0,0.35);color:#fff;padding:6px 8px;border-radius:8px;z-index:1000;font-size:13px}
  @media(max-width:560px){ input[type="search"]{width:140px} .topbar{padding:8px} #map{top:52px} }
  .popup-title{font-weight:900;margin-bottom:6px}
  .small-muted{font-size:13px;color:#ddd}
</style>
</head>
<body>
  <div class="topbar" role="navigation" aria-label="Map controls">
    <div class="brand">
      <div class="logo" title="PirateRuler">PR</div>
    </div>

    <div class="controls" role="search" aria-label="Map search">
      <div class="search" title="Filter flights">
        <input id="filterInput" type="search" placeholder="Filter by callsign / reg / icao24" aria-label="Filter">
        <button id="filterBtn" class="btn">Filter</button>
      </div>
      <a href="/" class="btn" style="background:transparent;border:1px solid rgba(255,255,255,0.07);color:#fff;font-weight:800;padding:8px 10px;border-radius:8px">Home</a>
    </div>
  </div>

  <div id="map" role="application" aria-label="Flight map"></div>

  <div class="legend">Leaflet | © OpenStreetMap contributors</div>
  <div id="status" class="status" aria-live="polite">Initializing…</div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script>
  // ---------- Minimal changes: fetch fallback logic added ----------
  // Tries: 1) Direct OpenSky, 2) AllOrigins CORS proxy, 3) demo fallback
  // Keeps UI identical.

  const map = L.map('map', { zoomControl: true }).setView([39.0, 18.0], 5);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap contributors' }).addTo(map);

  const clusterGroup = L.markerClusterGroup({ chunkedLoading: true, maxClusterRadius: 60, disableClusteringAtZoom: 13 });
  clusterGroup.addTo(map);

  const statusEl = document.getElementById('status');
  const filterInput = document.getElementById('filterInput');
  document.getElementById('filterBtn').addEventListener('click', applyFilter);
  filterInput.addEventListener('keydown', (e)=>{ if(e.key === 'Enter') applyFilter(); });

  // demo markers used when live fails
  const demoAircraft = [
    { icao24:'demo1', reg:'G-ABCD', callsign:'BAW123', lat:51.5, lon:-0.12, alt:35000, hdg:90, source:'demo' },
    { icao24:'demo2', reg:'N12345', callsign:'DAL456', lat:41.9, lon:12.5, alt:28000, hdg:45, source:'demo' },
    { icao24:'demo3', reg:'A6-XYZ', callsign:'UAE789', lat:30.4, lon:31.2, alt:32000, hdg:270, source:'demo' }
  ];

  // state
  let aircraftByIcao = {};
  let renderQueue = [];
  const BATCH_SIZE = 200;

  function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch])); }
  function aircraftIcon(hdg){ return L.divIcon({ html: `<div style="transform:rotate(${hdg||0}deg);font-size:18px;line-height:0">✈️</div>`, className: '' }); }

  function enqueueAndRender(items){
    let added = 0;
    items.forEach(a => {
      if(!a || !a.icao24) return;
      if(aircraftByIcao[a.icao24]) {
        aircraftByIcao[a.icao24] = { ...aircraftByIcao[a.icao24], ...a };
        return;
      }
      aircraftByIcao[a.icao24] = a;
      renderQueue.push(a);
      added++;
    });
    if(added) processRenderQueue();
  }

  let processing = false;
  function processRenderQueue(){
    if(processing) return;
    processing = true;
    (function step(){
      const chunk = renderQueue.splice(0, BATCH_SIZE);
      if(chunk.length){
        const markers = chunk.map(a => {
          const m = L.marker([a.lat, a.lon], { icon: aircraftIcon(a.hdg || 0) });
          const popup = `<div class="popup-title">${escapeHtml(a.callsign||'—')} — ${escapeHtml(a.reg||a.icao24||'')}</div>
            <div class="small-muted">Alt: ${a.alt !== null && a.alt !== undefined ? (Math.round(a.alt) + ' ft') : 'N/A'}<br>
            Heading: ${a.hdg !== null && a.hdg !== undefined ? Math.round(a.hdg) + '°' : 'N/A'}<br>
            Source: ${escapeHtml(a.source || 'unknown')}</div>`;
          m.bindPopup(popup);
          return m;
        });
        clusterGroup.addLayers(markers);
        setTimeout(step, 60);
      } else {
        processing = false;
        statusEl.textContent = `Showing ${Object.keys(aircraftByIcao).length} aircraft`;
      }
    })();
  }

  function rebuildClustersFromState(){
    clusterGroup.clearLayers();
    const all = Object.values(aircraftByIcao);
    const markers = all.map(a => {
      const m = L.marker([a.lat, a.lon], { icon: aircraftIcon(a.hdg || 0) });
      m.bindPopup(`<div class="popup-title">${escapeHtml(a.callsign||'—')} — ${escapeHtml(a.reg||a.icao24||'')}</div>
        <div class="small-muted">Alt: ${a.alt || 'N/A'} ft<br>Heading: ${a.hdg || 'N/A'}°<br>Source: ${escapeHtml(a.source||'unknown')}</div>`);
      return m;
    });
    clusterGroup.addLayers(markers);
    statusEl.textContent = `Showing ${all.length} aircraft`;
  }

  function applyFilter(){
    const q = filterInput.value.trim().toLowerCase();
    if(!q){ rebuildClustersFromState(); return; }
    const values = Object.values(aircraftByIcao).filter(a => ((a.reg||'') + ' ' + (a.callsign||'') + ' ' + (a.icao24||'')).toLowerCase().includes(q));
    clusterGroup.clearLayers();
    const markers = values.map(a => {
      const m = L.marker([a.lat, a.lon], { icon: aircraftIcon(a.hdg || 0) });
      m.bindPopup(`<div class="popup-title">${escapeHtml(a.callsign||'—')} — ${escapeHtml(a.reg||a.icao24||'')}</div>
        <div class="small-muted">Alt: ${a.alt || 'N/A'} ft<br>Heading: ${a.hdg || 'N/A'}°<br>Source: ${escapeHtml(a.source||'unknown')}</div>`);
      return m;
    });
    clusterGroup.addLayers(markers);
    if(values.length) map.setView([values[0].lat, values[0].lon], 6);
    statusEl.textContent = `Filter: ${values.length} matches`;
  }

  // OpenSky area for Mediterranean default (fast). We'll fetch a few tiles to show many flights.
  const TILE_ROWS = 4; // keep small so page loads quick
  const TILE_COLS = 6;
  const TILE_FETCH_DELAY = 250;

  function buildOpenSkyUrl(lamin, lomin, lamax, lomax){
    return `https://opensky-network.org/api/states/all?lamin=${lamin}&lomin=${lomin}&lamax=${lamax}&lomax=${lomax}`;
  }

  // AllOrigins wrapper: https://api.allorigins.win/raw?url={encodedURL}
  function allOriginsUrl(url){
    return 'https://api.allorigins.win/raw?url=' + encodeURIComponent(url);
  }

  function parseOpenSkyStates(data){
    if(!data || !Array.isArray(data.states)) return [];
    return data.states.map(s => ({
      icao24: s[0],
      callsign: (s[1] || '').trim(),
      origin_country: s[2],
      time_position: s[3],
      last_contact: s[4],
      lon: s[5],
      lat: s[6],
      alt_baro: s[7],
      on_ground: s[8],
      velocity: s[9],
      hdg: s[10],
      vert_rate: s[11],
      source: 'OpenSky'
    })).filter(x => x.lat !== null && x.lon !== null).map(a => ({
      icao24: a.icao24,
      reg: a.icao24,
      callsign: a.callsign || a.icao24,
      lat: a.lat,
      lon: a.lon,
      alt: (a.alt_baro !== null && a.alt_baro !== undefined) ? Math.round(a.alt_baro * 3.28084) : null,
      hdg: a.hdg || 0,
      source: a.source
    }));
  }

  function generateTiles(rows, cols, bbox){
    const tiles = [];
    const latStep = (bbox.lamax - bbox.lamin) / rows;
    const lonStep = (bbox.lomax - bbox.lomin) / cols;
    for(let r=0;r<rows;r++){
      for(let c=0;c<cols;c++){
        const lamin = bbox.lamin + (r * latStep);
        const lamax = bbox.lamin + ((r+1) * latStep);
        const lomin = bbox.lomin + (c * lonStep);
        const lomax = bbox.lomin + ((c+1) * lonStep);
        tiles.push({ lamin, lomin, lamax, lomax });
      }
    }
    return tiles;
  }

  async function fetchTileWithFallback(lamin, lomin, lamax, lomax){
    // try direct
    const directUrl = buildOpenSkyUrl(lamin,lomin,lamax,lomax);
    try{
      const r = await fetch(directUrl, { cache:'no-store' });
      if(r.ok){
        const j = await r.json();
        return parseOpenSkyStates(j);
      } else {
        throw new Error('Direct HTTP '+r.status);
      }
    } catch(e){
      console.warn('Direct OpenSky failed, trying AllOrigins proxy', e);
      // try AllOrigins
      try{
        const corsUrl = allOriginsUrl(directUrl);
        const r2 = await fetch(corsUrl, { cache:'no-store' });
        if(r2.ok){
          const j2 = await r2.json();
          return parseOpenSkyStates(j2);
        } else {
          throw new Error('AllOrigins HTTP '+r2.status);
        }
      } catch(e2){
        console.warn('AllOrigins failed', e2);
        return null; // indicate failure
      }
    }
  }

  async function fetchTilesAndRender(){
    statusEl.textContent = 'Preparing tiles…';
    const bbox = { lamin: 20, lomin: -20, lamax: 54, lomax: 40 }; // reasonable region to populate quickly
    const tiles = generateTiles(TILE_ROWS, TILE_COLS, bbox);
    statusEl.textContent = `Fetching ${tiles.length} tiles…`;

    for(let i=0;i<tiles.length;i++){
      const t = tiles[i];
      statusEl.textContent = `Fetching tile ${i+1}/${tiles.length}…`;
      const parsed = await fetchTileWithFallback(t.lamin, t.lomin, t.lamax, t.lomax);
      if(parsed && parsed.length){
        enqueueAndRender(parsed);
      } else {
        // on first failure (likely CORS), fallback to AllOrigins tried; if still null, fallback to demo and stop
        if(i === 0){
          statusEl.textContent = 'Live fetch blocked. Showing demo. (You can run a server proxy for full live data)';
          enqueueAndRender(demoAircraft);
          return;
        }
      }
      await new Promise(res=>setTimeout(res, TILE_FETCH_DELAY));
    }
    statusEl.textContent = `Tile load complete — ${Object.keys(aircraftByIcao).length} unique aircraft`;
  }

  // start
  (async function init(){
    enqueueAndRender(demoAircraft); // immediate content
    await fetchTilesAndRender();
    // periodic refresh
    setInterval(fetchTilesAndRender, 45000);
  })();

  // expose reload for console
  window.reloadAircraft = fetchTilesAndRender;

  </script>
</body>
</html>
