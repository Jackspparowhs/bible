<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Flight Tracker Map — PirateRuler.com</title>
<link rel="icon" href="https://pirateruler.com/static/pr-logo.png" type="image/png">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
<style>
  html,body,#map{height:100%;margin:0;padding:0}
  body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial; background:#071225; color:#e9f1ff}
  /* top header bar (minimal: small logo + controls) */
  .topbar{
    display:flex;align-items:center;justify-content:space-between;padding:8px 12px;
    background:linear-gradient(90deg, rgba(6,16,40,0.9), rgba(7,18,37,0.9));
    color:#fff; box-shadow:0 6px 18px rgba(0,0,0,0.45); position:relative; z-index:1000;
    gap:12px;
  }
  .brand{display:flex;align-items:center;gap:10px}
  .logo{
    width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg,#6bbf4a,#2fa64f);
    display:flex;align-items:center;justify-content:center;font-weight:900;font-size:14px;color:#06221a;
    box-shadow:0 6px 18px rgba(0,0,0,0.35);
  }
  .controls{display:flex;gap:8px;align-items:center}
  .search {
    display:flex;align-items:center;gap:8px;background:rgba(255,255,255,0.03);padding:6px 8px;border-radius:8px;
  }
  input[type="search"]{background:transparent;border:0;color:#fff;outline:0;padding:6px 8px;font-size:14px;width:220px}
  .btn {
    cursor:pointer;border:0;padding:8px 10px;border-radius:8px;background:linear-gradient(90deg,#6bbf4a,#2fa64f);color:#fff;font-weight:800;
    font-size:13px;
  }
  /* map container sits below topbar */
  #map{position:absolute;top:56px;bottom:0;left:0;right:0}
  /* small unobtrusive status (bottom-right) */
  .status {
    position: absolute;
    right: 12px;
    bottom: 12px;
    z-index: 1000;
    background: rgba(0,0,0,0.45);
    color: #fff;
    padding: 6px 10px;
    border-radius: 8px;
    font-size: 13px;
    pointer-events: none;
    opacity: 0.95;
  }
  .legend{position:absolute;left:12px;bottom:12px;background:rgba(0,0,0,0.35);color:#fff;padding:6px 8px;border-radius:8px;z-index:1000;font-size:13px}
  /* cluster style small adjustments */
  .marker-cluster-small { background-color: rgba(75, 180, 80, 0.9); }
  .marker-cluster-medium { background-color: rgba(50,160,60,0.95); }
  .marker-cluster-large { background-color: rgba(30,120,45,0.95); }
  @media(max-width:560px){
    input[type="search"]{width:140px}
    .topbar{padding:8px}
    #map{top:52px}
  }
  .popup-title{font-weight:900;margin-bottom:6px}
  .small-muted{font-size:13px;color:#ddd}
</style>
</head>
<body>
  <div class="topbar" role="navigation" aria-label="Map controls">
    <div class="brand" aria-hidden="false">
      <div class="logo" title="PirateRuler">PR</div>
      <!-- name removed intentionally (clean UI) -->
    </div>

    <div class="controls" role="search" aria-label="Map search">
      <div class="search" title="Filter flights">
        <input id="filterInput" type="search" placeholder="Filter by callsign / reg / icao24" aria-label="Filter">
        <button id="filterBtn" class="btn">Filter</button>
      </div>
      <a href="/" class="btn" style="background:transparent;border:1px solid rgba(255,255,255,0.07);color:#fff;font-weight:800;padding:8px 10px;border-radius:8px">Home</a>
    </div>
  </div>

  <div id="map" role="application" aria-label="Flight map"></div>

  <div class="legend">Leaflet | © OpenStreetMap contributors</div>
  <div id="status" class="status" aria-live="polite">Initializing…</div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script>
    // --- Map init (centered over Mediterranean / Europe by default; user can pan/zoom) ---
    const map = L.map('map', { zoomControl: true }).setView([39.0, 18.0], 5);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // marker cluster group for performance & cleanliness
    const clusterGroup = L.markerClusterGroup({
      chunkedLoading: true,
      maxClusterRadius: 60,
      disableClusteringAtZoom: 13
    }).addTo(map);

    // fallback demo aircraft (used when live fetch is blocked)
    const demoAircraft = [
      { id: 'demo-1', reg: 'G-ABCD', callsign: 'BAW123', lat: 51.5, lon: -0.12, alt: 35000, hdg: 90 },
      { id: 'demo-2', reg: 'N12345', callsign: 'DAL456', lat: 41.9, lon: 12.5, alt: 28000, hdg: 45 },
      { id: 'demo-3', reg: 'A6-XYZ', callsign: 'UAE789', lat: 30.4, lon: 31.2, alt: 32000, hdg: 270 },
      { id: 'demo-4', reg: 'VP-CDE', callsign: 'BAW888', lat: 40.4, lon: 3.7, alt: 33000, hdg: 210 }
    ];

    // state
    let currentAircraft = demoAircraft.slice();
    const statusEl = document.getElementById('status');

    // helper: add markers (clustered)
    function plotAircraft(list){
      clusterGroup.clearLayers();
      if(!list || list.length === 0){
        statusEl.textContent = 'No aircraft to display';
        return;
      }
      const markers = list.map(a => {
        const htmlIcon = L.divIcon({
          html: `<div style="transform:rotate(${a.hdg || 0}deg);font-size:18px;line-height:0">✈️</div>`,
          className: ''
        });
        const m = L.marker([a.lat, a.lon], { icon: htmlIcon });
        const popup = `
          <div class="popup-title">${escapeHtml(a.callsign || '—')} — ${escapeHtml(a.reg || a.icao24 || '')}</div>
          <div class="small-muted">Alt: ${a.alt !== null && a.alt !== undefined ? Math.round(a.alt) + ' ft' : 'N/A'}<br>
          Heading: ${a.hdg !== null && a.hdg !== undefined ? Math.round(a.hdg) + '°' : 'N/A'}<br>
          Source: ${escapeHtml(a.source || 'demo')}</div>
        `;
        m.bindPopup(popup);
        return m;
      });
      clusterGroup.addLayers(markers);
      statusEl.textContent = `Showing ${list.length} aircraft`;
      // fit bounds lightly when first load and list has many markers
      try {
        const bounds = clusterGroup.getBounds();
        if(bounds.isValid()) {
          // only fit on initial loads if zoom level is low
          if(map.getZoom() < 6) map.fitBounds(bounds.pad(0.35));
        }
      } catch(e){}
    }

    function escapeHtml(s){ return String(s || '').replace(/[&<>"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch])); }

    // filter UI
    const input = document.getElementById('filterInput');
    document.getElementById('filterBtn').addEventListener('click', applyFilter);
    input.addEventListener('keydown', e => { if(e.key === 'Enter') applyFilter(); });

    function applyFilter(){
      const q = input.value.trim().toLowerCase();
      if(!q){ plotAircraft(currentAircraft); return; }
      const filtered = currentAircraft.filter(a => ((a.reg||'') + ' ' + (a.callsign||'') + ' ' + (a.icao24||'')).toLowerCase().includes(q));
      if(filtered.length){
        plotAircraft(filtered);
        map.setView([filtered[0].lat, filtered[0].lon], 7);
      } else {
        clusterGroup.clearLayers();
        statusEl.textContent = `No results for "${q}"`;
      }
    }

    // --- Live API: OpenSky Network ---
    // Expanded bounding box to include much of Europe / Mediterranean / N Africa / Eastern Atlantic
    // lamin=20, lomin=-20, lamax=54, lomax=40  (bigger area)
    // Endpoint: https://opensky-network.org/api/states/all?lamin=20&lomin=-20&lamax=54&lomax=40
    // We'll fetch up to 800 aircraft and rely on clustering.
    async function fetchOpenSky(){
      const url = 'https://opensky-network.org/api/states/all?lamin=20&lomin=-20&lamax=54&lomax=40';
      try {
        statusEl.textContent = 'Fetching live aircraft…';
        const resp = await fetch(url, { cache: 'no-store' });
        if(!resp.ok) throw new Error('HTTP ' + resp.status);
        const data = await resp.json();
        if(!data.states || !Array.isArray(data.states)) throw new Error('Bad format');
        // map OpenSky state vectors to objects
        const mapped = data.states.map(s => ({
          icao24: s[0],
          callsign: (s[1] || '').trim(),
          origin_country: s[2],
          time_position: s[3],
          last_contact: s[4],
          lon: s[5],
          lat: s[6],
          alt_baro: s[7],
          on_ground: s[8],
          velocity: s[9],
          hdg: s[10],
          vert_rate: s[11],
          source: 'OpenSky'
        })).filter(a => a.lat !== null && a.lon !== null);

        // limit (avoid extreme payloads)
        const limited = mapped.slice(0, 800);
        // convert to render format (alt in meters -> ft)
        const ready = limited.map(a => ({
          id: a.icao24,
          icao24: a.icao24,
          reg: a.icao24,
          callsign: a.callsign || a.icao24,
          lat: a.lat,
          lon: a.lon,
          alt: (a.alt_baro !== null && a.alt_baro !== undefined) ? Math.round(a.alt_baro * 3.28084) : null,
          hdg: a.hdg || 0,
          source: 'OpenSky'
        }));

        currentAircraft = ready;
        plotAircraft(currentAircraft);
        return true;
      } catch (err) {
        console.warn('OpenSky fetch failed:', err);
        // fallback to demo set
        statusEl.textContent = 'Live fetch failed (CORS or network). Showing demo. Use a server proxy for live data.';
        currentAircraft = demoAircraft.slice();
        plotAircraft(currentAircraft);
        return false;
      }
    }

    // initial load
    (async function init(){
      plotAircraft(demoAircraft); // immediate visual
      const ok = await fetchOpenSky();
      if(!ok){
        // try again but don't spam; user can click reloadAircraft() from console
        // we still poll occasionally to catch temporary issues
        setTimeout(fetchOpenSky, 10000);
      }
    })();

    // poll every 20s when OpenSky is accessible
    let pollTimer = setInterval(fetchOpenSky, 20000);

    // expose manual reload (console/testing)
    window.reloadAircraft = fetchOpenSky;

    // console hint if CORS blocked
    console.log('%cIf OpenSky CORS blocks requests, run a small server-side proxy that forwards /api/states/all to opensky-network.org and point this client there.', 'color:#9ad66b');

  </script>
</body>
</html>
